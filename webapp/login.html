<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>登录 - WAF 管理系统</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
<div class="auth-container">
    <div class="header">
        <h1>登录</h1>
        <p>欢迎使用 WAF 管理系统</p>
    </div>

    <form id="loginForm">
        <div class="form-group">
            <label class="form-label">用户名</label>
            <input type="text" class="form-input" name="username" placeholder="请输入用户名" required />
        </div>

        <div class="form-group">
            <label class="form-label">密码</label>
            <div style="position: relative;">
                <input type="password" class="form-input" id="passwordInput" name="password" placeholder="请输入密码" required />
                <i id="togglePwd" class="fas fa-eye" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#666;"></i>
            </div>
        </div>

        <div class="button-group">
            <button type="submit" class="btn btn-primary"><i class="fas fa-sign-in-alt"></i> 登录</button>
            <button type="reset" class="btn btn-secondary"><i class="fas fa-redo"></i> 重置</button>
        </div>
    </form>

    <div class="footer">
        <a href="register.html" class="btn-link"><i class="fas fa-user-plus"></i> 没有账号？去注册</a>
    </div>
</div>

<script>
    (async () => {
        const form = document.getElementById('loginForm');
        const submitBtn = form.querySelector('button[type="submit"]');
        const passwordInput = document.getElementById('passwordInput');
        const togglePwd = document.getElementById('togglePwd');

        // 显示错误信息
        function showError(msg) {
            let err = document.getElementById('loginError');
            if (!err) {
                err = document.createElement('div');
                err.id = 'loginError';
                err.style.color = '#c0392b';
                err.style.marginTop = '10px';
                form.parentNode.insertBefore(err, form.nextSibling);
            }
            err.textContent = msg;
        }

        // 密码可见切换
        togglePwd.addEventListener('click', () => {
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                togglePwd.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                togglePwd.classList.replace('fa-eye-slash', 'fa-eye');
            }
        });

        // 尝试刷新 token
        async function tryRefresh(refreshToken) {
            if (!refreshToken) return false;
            try {
                const resp = await fetch('/api/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });
                let payload = null;
                if ((resp.headers.get('content-type') || '').includes('application/json')) {
                    try { payload = await resp.json(); } catch {}
                }
                if (resp.ok && payload?.code === 200 && payload.data?.accessToken) {
                    localStorage.setItem('accessToken', payload.data.accessToken);
                    if (payload.data.refreshToken) localStorage.setItem('refreshToken', payload.data.refreshToken);
                    return true;
                } else {
                    localStorage.removeItem('accessToken');
                    if (resp.status === 401) localStorage.removeItem('refreshToken');
                    return false;
                }
            } catch {
                return false;
            }
        }

        // 页面加载时自动尝试刷新
        const storedRefresh = localStorage.getItem('refreshToken');
        const storedAccess = localStorage.getItem('accessToken');
        if (storedRefresh && !storedAccess) {
            const ok = await tryRefresh(storedRefresh);
            if (ok) {
                window.location.href = 'dashboard.html';
                return;
            }
        }

        // 登录表单提交
        form.addEventListener('submit', async e => {
            e.preventDefault();
            showError('');
            const username = e.target.username.value.trim();
            const password = e.target.password.value;

            if (!username || !password) {
                showError('用户名和密码不能为空');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登录中...';

            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                let body = null;
                if ((resp.headers.get('content-type') || '').includes('application/json')) {
                    try { body = await resp.json(); } catch {}
                }

                if (resp.ok && body?.code === 200 && body.data?.accessToken) {
                    localStorage.setItem('accessToken', body.data.accessToken);
                    if (body.data.refreshToken) localStorage.setItem('refreshToken', body.data.refreshToken);
                    window.location.href = 'dashboard.html';
                } else {
                    const msg = body?.message || (resp.status === 401 ? '用户名或密码错误' : `登录失败 (${resp.status})`);
                    showError(msg);
                }
            } catch {
                showError('无法连接到服务器，请稍后重试');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> 登录';
            }
        });
    })();
</script>
</body>
</html>
